---
title: "Learning to load data from comtrade"
output:
  html_document:
    toc: true
---


```{r packages}
library(knitr)
opts_knit$set(root.dir="../..") # file paths are relative to the root of the project directory
library(tradeflows)
library(dplyr)
``` 

## UN comtrade API parameters
Load data from the [UN Comtrade API](http://comtrade.un.org/data/doc/api/).

Download a JSON file containing trade data for germany:
```{r download_JSON, eval=FALSE}
download.file("http://comtrade.un.org/api/get?cc=4407&r=276&p=all&rg=all&ps=2011,2010&px=HS&max=50000&fmt=json",
              destfile="data-raw/UNCOMTRADE_exp.JSON")
json <- jsonlite::fromJSON("data-raw/UNCOMTRADE_exp.JSON")
```


### ps Time Period
To download many years at once, paste them in a character string, separated by commas. I replaced this behavior, now you can use a vector. 
There is a "query complexity" limit on the number of years that can be used.
```{r time_query_complexity, eval=FALSE}
swd20002013 <- loadcomtrade_bycode(4407, 276, seq(2000,2012))
trying URL 'http://comtrade.un.org/api/get?cc=4407&r=276&p=all&rg=all&ps=2000,2001,2002,2003,2004,2005,2006,2007,2008,2009,2010,2011,2012&px=HS&max=50000&fmt=json'
Content type 'application/json; charset=utf-8' length 329 bytes
opened URL
==================================================
downloaded 329 bytes

Error in loadcomtrade_bycode(4407, 276, seq(2000, 2012)) : 
  list(name = "Query complexity", value = 5002, category = 0, description = "your query is too complex. Please simplify.", helpUrl = "")Too many years selected.list(value = 0, started = "0001-01-01T00:00:00", finished = "0001-01-01T00:00:00", durationSeconds = 0)NULL

has a limit of 50 000 records per request. But the max parameter is set by default to get only 500 records see for example, the time period below.

### max limit on the number of record

has a limit of 50 000 records per request. But the max parameter is set by default to get only 500 records see for example, the time period below.
The max parameter defaults to 500.
Illustration of a problem encountered as I had forgotten to set the max limit.
```{r max, eval=FALSE}
swd89101112 <- tradeflows::loadcomtrade_bycode(4407, 276, "2012,2011,2010,2009,2008", max=500)
# Year 2010 and 2011 are not in this table.
unique(swd89101112$yr)
# [[1]]
# [1] 2012
# 
# [[2]]
# [1] 2008
# 
# [[3]]
# [1] 2009


# But 2010 and 2011 are available in the comtrade API.
swd10_11 <- loadcomtrade_bycode(4407, 276, "2011,2010")
unique(swd10_11$yr)
# trying URL 'http://comtrade.un.org/api/get?cc=4407&r=276&p=all&rg=all&ps=2011,2010&px=HS&max=50000&fmt=json'
# Content type 'application/json; charset=utf-8' length 177788 bytes (173 Kb)
# opened URL
# ==================================================
# downloaded 173 Kb
# 
# > unique(swd10_11$yr)
# [[1]]
# [1] 2010
# 
# [[2]]
# [1] 2011
```


### px Classification
See below, the comparison of different classification schemes.
```{r classification}

```


### r Reporting Area
Try to load for all countries
```{r reporter, eval=FALSE}
swd <- loadcomtrade_bycode(4407, "all", 2013)

# trying URL 'http://comtrade.un.org/api/get?cc=4407&r=all&p=all&rg=all&ps=2013&px=HS&max=50000&fmt=json'
# 
# Content type 'application/json; charset=utf-8' length 405 bytes
# opened URL
# ==================================================
# downloaded 405 bytes
# 
# Quitting from lines 50-51 (input.Rmd) 
# Error in loadcomtrade_bycode(4407, "all", 2013) : 
#   list(name = "Query complexity", value = 5002, category = 0, description = "your query is too complex. Please simplify.", helpUrl = "")Both 'all' reporters and 'all' partners may not be selected. Select a different reporter or partner.list(value = 0, started = "0001-01-01T00:00:00", finished = "0001-01-01T00:00:00", durationSeconds = 0)NA
``` 


### Load Comtrade data with a function
```{r loadcomtrade_bycode, eval=FALSE}
years = seq(2000,2012)
swd2012 <- loadcomtrade_bycode(4407, 276, 2012)
swd20102011 <- loadcomtrade_bycode(4407, 276, c(2010, 2011))
swd20002013 <- loadcomtrade_bycode(4407, 276, seq(2008,2012))
``` 


## Classification
```{r}
load("data-raw/classificationcomtrade.RData") 
H4 <- classificationcomtrade$H4
H4 %>% filter(id=="4407")  %>% kable
H4 %>% filter(parent=="4407")  %>% kable
H4 %>% filter(id=="44")  %>% kable
H4 %>% filter(parent=="44") %>% kable
# Number of products under chapter 44
chap44 <- H4 %>% filter(substr(id, 0, 2)=="44")
nrow(chap44)
# Number of products under sawnwood
swd <- H4 %>% filter(substr(id, 0, 4)=="4407")
nrow(swd)    
```


### Changes in HS products classifications
```{r}
# Keep only chapter 44
classification44 <- lapply(classificationcomtrade, 
              function(dtf) filter(dtf, substr(id, 0, 2)=="44"))
HS <- classification44$HS
H4 <- classification44$H4 
# HSnotinH4 <- HS %>% filter(!id %in% H4$id)
# H4notinHS <- H4 %>% filter(!id %in% HS$id)
# Table of products disapearing and appearing
HS %>%
    merge(H4, by="id", all=TRUE, suffixes=c("HS", "H4")) %>%
    filter(is.na(textHS) | is.na(textH4)) %>%
    arrange(id) %>% 
    kable
# Do the same comparison between H3 and H4  
```


