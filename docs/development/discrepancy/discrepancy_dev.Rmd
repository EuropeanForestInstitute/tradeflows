---
title: "440799 discrepancies in ` reporterinreport`"
author: "Paul Rougieux"
date: "03/12/2014"
output:
  pdf_document:
    fig_width: 10
    toc: yes
---

```{r packages, echo=FALSE, warning=FALSE, message=FALSE}
# I tried placing the yaml block after the chunks but for some reason it doesn't always generate the pdf and generates a html file instead.
# pdf is generated when the yaml block is at the top, 

library(knitr)
opts_knit$set(root.dir="../../..") # file paths are relative to the root of the project directory
opts_chunk$set(echo=FALSE)
library(tradeflows)
library(dplyr)
library(ggplot2)
library(reshape2)
``` 


```{r development, eval=TRUE, echo=FALSE, message=FALSE, warning=FALSE}
# Remove this chunk (or eval=FALSE) when this file is used as a template
# The data frame tfdata will be passed by the report generating function to the template
# Product and reporter information can be extracted back from tfdata 
# in the template this would have to be the country appearing most in the data frame
productcode_ <- c(440799)
reporter_ <- "Cameroon" 
tfdata <- readdbtbl("raw_flow_yearly") %>%
    filter(productcode == productcode_ & (reporter == reporter_ | partner == reporter_)) %>%
    collect
```


```{r prepareproductandreporter}
# Only the tfdata variable is passed by the function that creates the report
# Extract product code and reporter from the tfdata. 
# Variables used for the file title
productcodeintitle <- unique(tfdata$productcode)
# In cases where there are many products replace this variable by ""
if(length(productcodeintitle)>1) productcodeintitle <- ""
nbyears <- length(unique(tfdata$year))
reporterintitle <- tfdata %>% group_by(reporter) %>%
    summarise(nrowperyear = n()/nbyears ) %>% filter(nrowperyear > 1)
reporterintitle <- reporterintitle$reporter
# In cases where there are many countries replace this variable by ""
if(length(productcodeintitle)>1) reporterintitle <- ""
# Calculate discrepancies
tfdata  <- tfdata %>% addpartnerflow %>% calculatediscrepancies 
```



## 9 largest trade flows 
### Reported by `r reporterinreport` 2 years before the last year available in the database
9 largest import or export flows in  `r unique(tfdata$unit)` where `r reporterinreport` is a reporter.

```{r}
# Select the largest import or export flows reported by the reporter
largestreporter <- tfdata %>% 
    filterworldeu28 %>%
    filter(year == (max(as.integer(year)) -2) & 
               reporter == reporterinreport) %>% 
    arrange(desc(quantity)) %>%
    head(9)

# Display these trade flows as a table
largestreporter %>% 
    select(year, reporter, partner, flow, flag, tradevalue, quantity) %>%
    kable

# Display these trade flows as a plot
largestreporter <- tfdata %>% 
    filterworldeu28 %>% 
    filter(partner %in% largestreporter$partner) %>%
    # reshape table for use in the plot
    select(year, partner, flow, quantity, discrq) %>%
    arrange(-quantity) %>%
    rename(discrepancy = discrq) %>%
    melt(id = c("year","partner","flow"))

ggplot(largestreporter, aes(x = year, y = value, fill = variable)) +
    geom_bar(position="dodge", stat="identity") +
    scale_fill_manual(values = c("chocolate3","black"))+
    facet_wrap(~partner) +
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) 
```


### Reported by its trade partners 2 years before the last
10 largest import or export flows in  `r unique(tfdata$unit)` where `r reporterinreport` is a partner.
```{r}
# Select the largest import or export flows reported by the reporter
largestpartner <- tfdata %>% 
    filter(year == (max(as.integer(year)) -2) & 
               partner == reporterinreport) %>% 
    arrange(desc(quantity)) %>%
    head(9)

# Display these trade flows as a table
largestpartner %>% 
    select(year, reporter, partner, flow, flag, tradevalue, quantity) %>%
    kable
# reshape table for use in the plot


```


### Discrepancies in the raw data
```{r eval=FALSE}
# reshape the table for the plot
 dtf2 %>% 
        filter(flow == flowselected & year == max(year) & productcode==p) %>%
        select(partner, weight, discrv) %>%
        arrange(-weight) %>%
        rename(discrepancy = discrv) %>%
        head(10)

ggplot(data=largest) +
    aes(x = partner, fill = quantity) +
    geom_bar(position="dodge", stat="identity") +
    scale_fill_manual(values = c("chocolate3","black"))+
    theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
    ggtitle(paste(flowselected, p))
```


### Discrepancies in the refined data


## Trade flows as a point cloud
```{r}
tfdata <- tfdata %>% filterworldeu28 %>% addregion
ggplot(tfdata, aes(x = year, y = quantity, color = regionreporter)) +
    geom_point() + facet_wrap(~flow) 
```


