---
title: "Using tradeflows function on the Comext data"
author: "Paul Rougieux"
date: "04/12/2014"
output: html_document
---


```{r packages, echo=FALSE, warning=FALSE, message=FALSE}
library(knitr)
opts_knit$set(root.dir="../../..") # file paths are relative to the root of the project directory
opts_chunk$set(echo=FALSE)
library(tradeflows)
library(dplyr)
library(ggplot2)
library(reshape2)
``` 


This document first tries to run the existing clean function 
- written for Comtrade data - on Comext data.
Then it describes the development process needed to make
the clean function work with Comext data.


# Note: It is very important to replace 0 zero values by NA
 
# Load data
```{r load_data_and_descriptive_statistics, echo=TRUE}
tableanalysed = 'raw_comext_monthly_201708' 

con <- RMySQL::dbConnect(RMySQL::MySQL(), dbname = "tradeflows")

# Use a product which doesn't have a 0 quantity
wp <- tbl(con, tableanalysed) %>% 
    filter(productcode == 44071031) %>% 
    collect()
# Descriptive statistics
# number of rows
wp %>% count()
# Summary of data columns for that product
summary(wp[c("tradevalue", "weight","quantity")])
# Number of 0 values
wp %>% filter(tradevalue == 0) %>% count()
wp %>% filter(weight== 0) %>% count()
wp %>% filter(quantity == 0) %>% count()
```


# Crash test

## Crash test run the clean() function alone
```{r eval=FALSE}
clean(wp)
```


## Run components of the clean() function one by one


```{r eval=FALSE}
# sanitycheck OK
wp %>% 
    sanitycheck() 

# filterworldeu28 OK
wp %>% 
    # add dummy reporter and partner columns 
    # mutate(reporter = NA,
    #        partner = NA) %>%  
    # Dummy reporter & partner are not necessary since 20170911, 
    # the filterworldeu28() function now checks for the presence
    # of a "reporter" column and gives a warning if not present.
    filterworldeu28()

# removeduplicatedflows
wp %>% 
    mutate(lastchanged = NA,
           flow = flowcode,
           reporter = reportercode) %>% # add dummy columns
    removeduplicatedflows()
    
# addconversionfactorandprice --> price/weight is missing, 
# add pricew = tradevalue / weight to the function
wp %>% 
    addconversionfactorandprice()

# addregion --> leads to erroneous region names since reportercde and partnercode a
# are different between the Comtrade and Comext.
wp %>% 
    addregion()

# extractprices
price <- wp %>% 
    mutate(flow = flowcode, 
           regionreporter = 1, 
           year = substr(as.character(period),1,4),
           unit = NA) %>% 
    addconversionfactorandprice() %>% 
    extractprices()

# extractconversionfactors
conversionfactor <- extractconversionfactors(dtf, geoaggregation = geoaggregation)
```


# Develop the clean function for Comext data

The goal is to reuse as many components from the Comtrade function 
as possible. When it is not possible to reuse and or modify a function 
written for Comtrade, then write a new function, which should still be 
present in the tradeflows package, but in a separate script called
`cleancomext.R`. These - Comext specific - functions 
might be moved later to the "eutradeflows" package if they become too numerous.
However, there is no need to complexify the package structure.
If there is only a handfull of - Comext speficic - functions, then they are well placed in tradeflows package.

```{r}
wp <- wp  %>% 
    addconversionfactorandprice() 

prices <- wp %>%
    # grouping by productcode is technicaly not necessary, because
    # cleaning operations are performed product by product.
    # But it doesn't cost much to keep the product information in the grouping,
    # and it might prevent confusion in later data processing,
    # so keep "productcode" in the grouping.
    extractprices(grouping = c("productcode", "flow", "year"))
```



```{r dbDisconnect}
RMySQL::dbDisconnect(con)
```

